#!/bin/bash

set -e

build_dir="${PWD}/build"
engine_dir="${PWD}/engine"

# Log configuration
log_debug="[::: BUILD DEBUG :::] "
log_info="[::: BUILD INFO :::] "
log_warning="[::: BUILD WARNING :::] "
log_error="[::: BUILD ERROR :::] "

# Set target options
declare -A targets
targets=(
    ["VS17"]="Visual Studio 17 2022"
    ["VS16"]="Visual Studio 16 2019"
    ["VS15"]="Visual Studio 15 2017"
    ["VS14"]="Visual Studio 14 2015"
    ["MinGW"]="MinGW Makefiles"
    ["NMake"]="NMake Makefiles"
    ["MSYS"]="MSYS Makefiles"
    ["Unix"]="Unix Makefiles"
)

# Set build mode options
modes=(
    full
    test
    rebuild
)

# Help command
help () {
    echo ""
    echo "Script for the LewEngine build process."
    echo ""
    echo "Arguments options:"
    echo ""
    echo "-t = Defines build target. Possible argument values: "${!targets[@]}""
    echo "Default is 'MinGW' if empty."
    echo ""
    echo "-m = Defines build mode. Possible argument values: "${modes[@]}""
    echo "Default is 'full' if empty."
    echo ""
    echo "-s = Skip mentioned components. Possible argument values: "${steps[@]}""
    echo "Default none."
    echo ""

    exit 0
}

# Parsing arguments
while getopts ":ht:m:s:" flag; do
    case "${flag}" in
        m) mode=${OPTARG};;
        t) target=${OPTARG};;
        s) skips=${OPTARG};;
        h) help;;
    esac
done

# Detecting the target build
if [ -z "$target" ]; then
    echo $log_warning"Target is empty ... setting default to MinGW"
    target="MinGW"
    target_set=true
else
    for t in "${!targets[@]}"; do
        if [ "$target" == "$t" ]; then
            echo $log_info"Target to build set to "$target
            target_set=true
            break
        fi
    done
fi

if [ -z "$target_set" ]; then
    echo $log_error"Target set does not exists. Please select from ${!targets[@]}"
    exit 1
fi

# Detecting build mode
if [ -z "$mode" ]; then
    echo $log_warning"Build mode is empty ... setting default to full"
    mode="full"
    mode_set=true
else
    for m in "${modes[@]}"; do
        if [ "$mode" == "$m" ]; then
            mode_set=true
            echo $log_info"Mode to build set to "$mode
            break
        fi
    done
fi

if [ -z "$mode_set" ]; then
    echo $log_error"Mode set does not exists. Please select from ${modes[@]}"
    exit 1
fi

# Starting build process
rm -rf ${build_dir}

cd ${engine_dir}
echo $log_info'Calling command: 'cmake' -S . -G '"${targets[$target]}"' -B '${build_dir}' -D MODE='${mode}''
cmake -S . -G "${targets[$target]}" -B ${build_dir} -D MODE=$mode | sed -e 's/^/'"${log_debug}"'/;'

cd ${build_dir}
echo $log_info'Calling command: make'
make | sed -e 's/^/'"${log_debug}"'/;'
